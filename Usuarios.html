<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Usuarios - Sistema de Inventario</title>
  <link rel="stylesheet" href="./front/styles.css" />
</head>

<body>
  <!-- Barra superior -->
  <div class="navbar">
    <h1>SISTEMA DE INVENTARIO</h1>
    <div class="menu">
      <a href="Interfaz.html">INVENTARIO</a>
      <a href="SistemaVentasAdmin.html">VENTA</a>
      <a href="ReportesAdmin.html">REPORTES</a>
      <a href="Usuarios.html">USUARIOS</a>
      <a href="index.html">‚Æê SALIR</a>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="main-content">
    <div class="users-grid" id="usersGrid"></div>
  </div>

  <!-- Bot√≥n para agregar usuario -->
  <button class="add-user-btn" onclick="openAddUserModal()">+</button>

  <!-- Modal para agregar usuario -->
  <div id="addUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>AGREGAR USUARIO</h2>
        <button class="close-btn" onclick="closeAddUserModal()">&times;</button>
      </div>
      <form id="addUserForm">
        <div class="form-group">
          <label for="userName">NOMBRE COMPLETO</label>
          <input type="text" id="userName" required placeholder="Ingresa el nombre completo" />
        </div>
        <div class="form-group">
          <label for="userRole">ROL</label>
          <select id="userRole" required>
            <option value="">Selecciona un rol</option>
            <option value="ADMIN">ADMIN</option>
            <option value="Supervisor">Supervisor</option>
            <option value="Cajero">Cajero</option>
          </select>
        </div>
        <div class="form-group">
          <label for="userEmail">EMAIL</label>
          <input type="email" id="userEmail" required placeholder="Ingresa el email" />
        </div>
        <div class="form-group">
          <label for="userPassword">CONTRASE√ëA</label>
          <input type="password" id="userPassword" required placeholder="Ingresa la contrase√±a" />
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn-cancel" onclick="closeAddUserModal()">CANCELAR</button>
          <button type="submit" class="btn-save">GUARDAR</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n de contrase√±a -->
  <div id="passwordConfirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>CONFIRMACI√ìN REQUERIDA</h2>
        <button class="close-btn" onclick="closePasswordConfirmModal()">&times;</button>
      </div>
      <div class="password-confirm">
        <h4>‚ö†Ô∏è CONTRASE√ëA DE ADMINISTRADOR REQUERIDA</h4>
        <p>Para modificar usuarios, debe ingresar la contrase√±a de administrador.</p>
      </div>
      <form id="passwordConfirmForm">
        <div class="form-group">
          <label for="adminPassword">CONTRASE√ëA DE ADMINISTRADOR</label>
          <input type="password" id="adminPassword" required placeholder="Ingrese la contrase√±a de administrador" />
          <div class="error-message" id="passwordError">Contrase√±a incorrecta. Intente nuevamente.</div>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn-cancel" onclick="closePasswordConfirmModal()">CANCELAR</button>
          <button type="submit" class="btn-save">CONFIRMAR</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para editar usuario -->
  <div id="editUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>EDITAR USUARIO</h2>
        <button class="close-btn" onclick="closeEditUserModal()">&times;</button>
      </div>
      <form id="editUserForm">
        <input type="hidden" id="editUserId" />
        <div class="form-group">
          <label for="editUserName">NOMBRE COMPLETO</label>
          <input type="text" id="editUserName" required placeholder="Ingresa el nombre completo" />
        </div>
        <div class="form-group">
          <label for="editUserRole">ROL</label>
          <select id="editUserRole" required>
            <option value="">Selecciona un rol</option>
            <option value="ADMIN">ADMIN</option>
            <option value="Supervisor">Supervisor</option>
            <option value="Cajero">Cajero</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editUserEmail">EMAIL</label>
          <input type="email" id="editUserEmail" required placeholder="Ingresa el email" />
        </div>
        <div class="form-group">
          <label for="editUserPassword">CONTRASE√ëA (dejar en blanco para no cambiar)</label>
          <input type="password" id="editUserPassword" placeholder="Nueva contrase√±a" />
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn-cancel" id="deleteUserBtn">ELIMINAR</button>
          <button type="submit" class="btn-save">ACTUALIZAR</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ======================
    // Variables globales
    // ======================
    let currentEditingUser = null;
    const ADMIN_PASSWORD = "admin123";
    const API_URL = "http://localhost:3000/api/usuarios";

    // ======================
    // Funciones de modales
    // ======================
    function openAddUserModal() {
      document.getElementById("addUserModal").style.display = "flex";
      document.getElementById("addUserForm").reset();
    }
    function closeAddUserModal() {
      document.getElementById("addUserModal").style.display = "none";
    }
    function openPasswordConfirmModal() {
      document.getElementById("passwordConfirmModal").style.display = "flex";
      document.getElementById("passwordConfirmForm").reset();
      document.getElementById("passwordError").style.display = "none";
      document.getElementById("adminPassword").focus();
    }
    function closePasswordConfirmModal() {
      document.getElementById("passwordConfirmModal").style.display = "none";
    }
    function openEditUserModal(userElement) {
      if (!userElement) return;

      const userId = userElement.getAttribute("data-id");
      const userName = userElement.querySelector(".user-name").textContent;
      const userRole = userElement.querySelector(".user-role").textContent;
      const userEmail = userElement.getAttribute("data-email");

      document.getElementById("editUserId").value = userId;
      document.getElementById("editUserName").value = userName;
      document.getElementById("editUserRole").value = userRole;
      document.getElementById("editUserEmail").value = userEmail;
      document.getElementById("editUserPassword").value = "";

      document.getElementById("editUserModal").style.display = "flex";
      document.getElementById("editUserName").focus();
    }
    function closeEditUserModal() {
      document.getElementById("editUserModal").style.display = "none";
      currentEditingUser = null;
    }

    // ======================
    // Cargar usuarios desde BD
    // ======================
    async function cargarUsuarios() {
      try {
        const response = await fetch(API_URL);
        const usuarios = await response.json();

        const usersGrid = document.getElementById("usersGrid");
        usersGrid.innerHTML = "";

        usuarios.forEach((u) => {
          const userCard = document.createElement("div");
          userCard.className = "user-card";
          userCard.setAttribute("data-id", u.id_usuario);
          userCard.setAttribute("data-email", u.correo);
          userCard.innerHTML = `
            <div class="user-role">${u.rol}</div>
            <div class="user-name">${u.nombre_completo}</div>
          `;
          userCard.addEventListener("click", function () {
            currentEditingUser = this;
            openPasswordConfirmModal();
          });
          usersGrid.appendChild(userCard);
        });
      } catch (error) {
        console.error("Error al cargar usuarios:", error);
      }
    }

    // ======================
    // Agregar usuario
    // ======================
    document
      .getElementById("addUserForm")
      .addEventListener("submit", async function (e) {
        e.preventDefault();

        const nuevoUsuario = {
          nombre_usuario: document.getElementById("userEmail").value.split("@")[0],
          nombre_completo: document.getElementById("userName").value,
          correo: document.getElementById("userEmail").value,
          contrase√±a: document.getElementById("userPassword").value,
          rol: document.getElementById("userRole").value,
        };

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(nuevoUsuario),
        });

        if (res.ok) {
          alert("Usuario agregado correctamente ‚úÖ");
          closeAddUserModal();
          cargarUsuarios();
        } else {
          alert("Error al agregar usuario ‚ùå");
        }
      });

    // ======================
    // Confirmar contrase√±a admin
    // ======================
    document
      .getElementById("passwordConfirmForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const adminPassword = document.getElementById("adminPassword").value;
        const passwordError = document.getElementById("passwordError");

        if (adminPassword === ADMIN_PASSWORD) {
          passwordError.style.display = "none";
          closePasswordConfirmModal();
          setTimeout(() => {
            if (currentEditingUser) openEditUserModal(currentEditingUser);
          }, 200);
        } else {
          passwordError.style.display = "block";
          document.getElementById("adminPassword").value = "";
          document.getElementById("adminPassword").focus();
        }
      });

    // ======================
    // Editar usuario (actualizar BD)
    // ======================
    document
      .getElementById("editUserForm")
      .addEventListener("submit", async function (e) {
        e.preventDefault();

        const id = document.getElementById("editUserId").value;
        const usuarioActualizado = {
          nombre_completo: document.getElementById("editUserName").value,
          correo: document.getElementById("editUserEmail").value,
          rol: document.getElementById("editUserRole").value,
          contrase√±a: document.getElementById("editUserPassword").value,
        };

        const res = await fetch(`${API_URL}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(usuarioActualizado),
        });

        if (res.ok) {
          alert("Usuario actualizado correctamente ‚úÖ");
          closeEditUserModal();
          cargarUsuarios();
        } else {
          alert("Error al actualizar usuario ‚ùå");
        }
      });

    // ======================
    // Eliminar usuario
    // ======================
    document.getElementById("deleteUserBtn").addEventListener("click", async function () {
  const id = document.getElementById("editUserId").value;
  const confirmacion = confirm("¬øSeguro que deseas eliminar este usuario?");
  if (!confirmacion) return;

  const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });

  if (res.ok) {
    alert("Usuario eliminado correctamente üóëÔ∏è");
    closeEditUserModal();
    cargarUsuarios();
  } else {
    alert("Error al eliminar usuario ‚ùå");
  }
});


    // ======================
    // Cerrar modales al hacer clic fuera
    // ======================
    window.addEventListener("click", function (e) {
      ["addUserModal", "passwordConfirmModal", "editUserModal"].forEach((id) => {
        const modal = document.getElementById(id);
        if (e.target === modal) modal.style.display = "none";
      });
    });

    // ======================
    // Cargar al iniciar
    // ======================
    document.addEventListener("DOMContentLoaded", cargarUsuarios);
  </script>
</body>
</html>
