<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supervisor - Sistema de Inventario</title>
  <link rel="stylesheet" href="./front/styles.css">
</head>
<body>
  <!-- Barra superior -->
  <div class="navbar">
    <h1>SISTEMA DE INVENTARIO</h1>
    <div class="menu">
      <a href="SistemaVentas.html">VENTA</a>
      <a href="Reportes.html">REPORTES</a>
      <a href="index.html">‚Æê SALIR</a>
    </div>
  </div>

  <!-- Contenedor -->
  <div class="container">
    <!-- Lista de productos -->
    <div class="inventory" id="inventoryList">
      <div class="search-box">
        <input type="text" placeholder="üîç B√∫squeda" id="searchInput">
      </div>

      <!-- Productos desde la BD -->
      <div id="dbItemsAnchor"></div>
    </div>

    <!-- Botones -->
    <div class="controls">
      <button class="btn btn-add" onclick="openAddModal()">AGREGAR</button>
      <button class="btn btn-delete" onclick="openDeleteModal()">ELIMINAR</button>
    </div>
  </div>

  <!-- Modal editar -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>EDITAR PRODUCTO</h2>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editForm">
        <div class="form-group"><label for="editName">NOMBRE</label><input type="text" id="editName" required></div>
        <div class="form-group"><label for="editTipo">TIPO</label><input type="text" id="editTipo" required></div>
        <div class="form-group"><label for="editDescripcion">DESCRIPCI√ìN</label><input type="text" id="editDescripcion" required></div>
        <div class="form-group"><label for="editQuantity">STOCK</label><input type="number" id="editQuantity" min="0" required></div>
        <div class="form-group"><label for="editStockMinimo">STOCK M√çNIMO</label><input type="number" id="editStockMinimo" min="0" required></div>
        <div class="form-group"><label for="editPrice">PRECIO</label><input type="number" id="editPrice" min="0" step="0.01" required></div>

        <div class="modal-buttons">
          <button type="button" class="btn btn-cancel" onclick="closeEditModal()">CANCELAR</button>
          <button type="submit" class="btn btn-save">GUARDAR</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal agregar -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>AGREGAR PRODUCTO</h2>
        <button class="close-btn" onclick="closeAddModal()">&times;</button>
      </div>
      <form id="addForm">
        <div class="form-group"><label for="addName">NOMBRE</label><input type="text" id="addName" required></div>
        <div class="form-group"><label for="addTipo">TIPO</label><input type="text" id="addTipo" placeholder="Ej: botana, bebida..." required></div>
        <div class="form-group"><label for="addDescripcion">DESCRIPCI√ìN</label><input type="text" id="addDescripcion" placeholder="Descripci√≥n del producto" required></div>
        <div class="form-group"><label for="addQuantity">STOCK</label><input type="number" id="addQuantity" min="0" required></div>
        <div class="form-group"><label for="addStockMinimo">STOCK M√çNIMO</label><input type="number" id="addStockMinimo" min="0" required></div>
        <div class="form-group"><label for="addPrice">PRECIO</label><input type="number" id="addPrice" min="0" step="0.01" required></div>

        <div class="modal-buttons">
          <button type="button" class="btn btn-cancel" onclick="closeAddModal()">CANCELAR</button>
          <button type="submit" class="btn btn-confirm-add">AGREGAR</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal eliminar -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header delete-modal-header">
        <h2>ELIMINAR</h2>
        <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
      </div>
      <form id="deleteForm">
        <div class="warning-text">‚ö†Ô∏è Esta acci√≥n no se puede deshacer</div>
        <div class="form-group">
          <label for="deleteId">ID ART√çCULO</label>
          <input type="text" id="deleteId" required>
        </div>
        <div class="separator"></div>
        <div class="modal-buttons">
          <button type="button" class="btn btn-cancel" onclick="closeDeleteModal()">CANCELAR</button>
          <button type="submit" class="btn btn-confirm-delete">ELIMINAR</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:3000/api/productos";

    // Crear producto visual
    function createItemElement(p) {
      const div = document.createElement("div");
      div.className = "item";
      div.dataset.id = p.id_producto;
      div.dataset.tipo = p.tipo ?? "";
      div.dataset.descripcion = p.descripcion ?? "";

      const info = document.createElement("div");
      info.className = "item-info";
      info.title = `Tipo: ${p.tipo ?? ""} | Descripci√≥n: ${p.descripcion ?? ""}`;
      const precioTxt = Number(p.precio ?? 0).toFixed(2);
      info.innerHTML = `<strong>${p.nombre}</strong> ‚Äî ID: ${p.id_producto} ‚Äî CANTIDAD: ${p.stock} ‚Äî STOCK M√çNIMO: ${p.stock_minimo} ‚Äî PRECIO: $${precioTxt}`;

      const btn = document.createElement("button");
      btn.className = "btn btn-edit";
      btn.textContent = "EDITAR";
      btn.onclick = () => openEditModal(btn);

      div.appendChild(info);
      div.appendChild(btn);
      return div;
    }

    // Cargar productos
    async function loadProductos() {
      try {
        const res = await fetch(API_URL);
        const productos = await res.json();

        const anchor = document.getElementById("dbItemsAnchor");
        anchor.innerHTML = "";

        if (productos.length === 0) {
          anchor.innerHTML = `<p style="text-align:center; padding:1rem;">No hay productos registrados.</p>`;
          return;
        }

        productos.forEach(p => anchor.appendChild(createItemElement(p)));
      } catch (err) {
        console.error("Error al cargar productos:", err);
      }
    }

    // Buscador
    document.getElementById("searchInput").addEventListener("input", async (e) => {
      const term = e.target.value.trim();
      try {
        const url = term ? `${API_URL}?search=${encodeURIComponent(term)}` : API_URL;
        const res = await fetch(url);
        const productos = await res.json();

        const anchor = document.getElementById("dbItemsAnchor");
        anchor.innerHTML = "";

        if (productos.length === 0) {
          anchor.innerHTML = `<p style="padding:1rem; text-align:center;">No se encontraron productos.</p>`;
          return;
        }

        productos.forEach((p) => anchor.appendChild(createItemElement(p)));
      } catch (error) {
        console.error("Error al buscar productos:", error);
      }
    });

    // -------- MODALES --------
    function openAddModal(){ document.getElementById('addModal').style.display='flex'; }
    function closeAddModal(){ document.getElementById('addModal').style.display='none'; }
    function openEditModal(btn){
      const item = btn.closest('.item');
      const infoText = item.querySelector('.item-info').textContent;
      const nombreMatch = infoText.match(/^\s*(.*?)\s*‚Äî/);
      const cantidadMatch = infoText.match(/CANTIDAD:\s*(\d+)/);
      const stockMinMatch = infoText.match(/STOCK M√çNIMO:\s*(\d+)/);
      const precioMatch = infoText.match(/PRECIO:\s*\$(\d+(?:\.\d+)?)/);

      document.getElementById('editName').value = (nombreMatch ? nombreMatch[1] : "").trim();
      document.getElementById('editQuantity').value = cantidadMatch ? cantidadMatch[1] : 0;
      document.getElementById('editStockMinimo').value = stockMinMatch ? stockMinMatch[1] : 0;
      document.getElementById('editPrice').value = precioMatch ? precioMatch[1] : 0;
      document.getElementById('editTipo').value = item.dataset.tipo || "";
      document.getElementById('editDescripcion').value = item.dataset.descripcion || "";
      document.getElementById('editForm').dataset.id = item.dataset.id;
      document.getElementById('editModal').style.display='flex';
    }
    function closeEditModal(){ document.getElementById('editModal').style.display='none'; }
    function openDeleteModal(){ document.getElementById('deleteModal').style.display='flex'; }
    function closeDeleteModal(){ document.getElementById('deleteModal').style.display='none'; }

    // -------- CRUD --------
    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const data = {
          nombre: addName.value,
          tipo: addTipo.value,
          descripcion: addDescripcion.value,
          stock: addQuantity.value,
          stock_minimo: addStockMinimo.value,
          precio: addPrice.value
        };
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const j = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(j.message || 'Error al agregar producto');
        alert('‚úÖ Producto agregado correctamente');
        await loadProductos();
        closeAddModal();
        e.target.reset();
      } catch (err) {
        console.error('‚ùå addForm:', err);
        alert(err.message);
      }
    });

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = e.target.dataset.id;
      try {
        const data = {
          nombre: editName.value,
          tipo: editTipo.value,
          descripcion: editDescripcion.value,
          stock: editQuantity.value,
          stock_minimo: editStockMinimo.value,
          precio: editPrice.value
        };
        const res = await fetch(`${API_URL}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const j = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(j.message || 'Error al actualizar producto');
        alert('‚úÖ Producto actualizado correctamente');
        await loadProductos();
        closeEditModal();
      } catch (err) {
        console.error('‚ùå editForm:', err);
        alert(err.message);
      }
    });

    document.getElementById('deleteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = deleteId.value.trim();
      if (!id) { alert('Ingresa un ID v√°lido'); return; }
      try {
        const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        const j = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(j.message || 'Error al eliminar producto');
        alert('üóëÔ∏è Producto eliminado correctamente');
        const card = document.querySelector(`.item[data-id='${id}']`);
        if (card) card.remove();
        closeDeleteModal();
      } catch (err) {
        console.error('‚ùå deleteForm:', err);
        alert(err.message);
      }
    });

    document.addEventListener("DOMContentLoaded", loadProductos);
  </script>
</body>
</html>
