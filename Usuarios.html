<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Usuarios - Sistema de Inventario</title>
  <link rel="stylesheet" href="./front/styles.css" />
</head>

<body>
  <!-- Barra superior -->
  <div class="navbar">
    <h1>SISTEMA DE INVENTARIO</h1>
    <div class="menu">
      <a href="Interfaz.html">INVENTARIO</a>
      <a href="SistemaVentasAdmin.html">VENTA</a>
      <a href="ReportesAdmin.html">REPORTES</a>
      <a href="Usuarios.html">USUARIOS</a>
      <a href="index.html">‚Æê SALIR</a>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="main-content">
    <div class="users-grid" id="usersGrid"></div>
  </div>

  <!-- Bot√≥n para agregar usuario -->
  <button class="add-user-btn" onclick="openAddUserModal()">+</button>

  <!-- Modal para agregar usuario -->
  <div id="addUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>AGREGAR USUARIO</h2>
        <button class="close-btn" onclick="closeAddUserModal()">&times;</button>
      </div>
      <form id="addUserForm">
        <div class="form-group">
          <label for="userName">NOMBRE COMPLETO</label>
          <input type="text" id="userName" required placeholder="Ingresa el nombre completo" />
        </div>
        <div class="form-group">
          <label for="userRole">ROL</label>
          <select id="userRole" required>
            <option value="">Selecciona un rol</option>
            <option value="ADMIN">ADMIN</option>
            <option value="Supervisor">Supervisor</option>
            <option value="Cajero">Cajero</option>
          </select>
        </div>
        <div class="form-group">
          <label for="userEmail">EMAIL</label>
          <input type="email" id="userEmail" required placeholder="Ingresa el email" />
        </div>
        <div class="form-group">
          <label for="userPassword">CONTRASE√ëA</label>
          <input type="password" id="userPassword" required placeholder="Ingresa la contrase√±a" />
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn-cancel" onclick="closeAddUserModal()">CANCELAR</button>
          <button type="submit" class="btn-save">GUARDAR</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n de contrase√±a -->
  <div id="passwordConfirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>CONFIRMACI√ìN REQUERIDA</h2>
        <button class="close-btn" onclick="closePasswordConfirmModal()">&times;</button>
      </div>
      <div class="password-confirm">
        <h4>‚ö†Ô∏è CONTRASE√ëA DE ADMINISTRADOR REQUERIDA</h4>
        <p>Para modificar usuarios, debe ingresar la contrase√±a de administrador.</p>
      </div>
      <form id="passwordConfirmForm">
        <div class="form-group">
          <label for="adminPassword">CONTRASE√ëA DE ADMINISTRADOR</label>
          <input type="password" id="adminPassword" required placeholder="Ingrese la contrase√±a de administrador" />
          <div class="error-message" id="passwordError">Contrase√±a incorrecta. Intente nuevamente.</div>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn-cancel" onclick="closePasswordConfirmModal()">CANCELAR</button>
          <button type="submit" class="btn-save">CONFIRMAR</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para editar usuario -->
  <div id="editUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>EDITAR USUARIO</h2>
        <button class="close-btn" onclick="closeEditUserModal()">&times;</button>
      </div>
      <form id="editUserForm">
        <input type="hidden" id="editUserId" />
        <div class="form-group">
          <label for="editUserName">NOMBRE COMPLETO</label>
          <input type="text" id="editUserName" required placeholder="Ingresa el nombre completo" />
        </div>
        <div class="form-group">
          <label for="editUserRole">ROL</label>
          <select id="editUserRole" required>
            <option value="">Selecciona un rol</option>
            <option value="ADMIN">ADMIN</option>
            <option value="Supervisor">Supervisor</option>
            <option value="Cajero">Cajero</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editUserEmail">EMAIL</label>
          <input type="email" id="editUserEmail" required placeholder="Ingresa el email" />
        </div>
        <div class="form-group">
          <label for="editUserPassword">CONTRASE√ëA (dejar en blanco para no cambiar)</label>
          <input type="password" id="editUserPassword" placeholder="Nueva contrase√±a" />
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn-cancel" id="openDeleteUserConfirmBtn">ELIMINAR</button>
          <button type="submit" class="btn-save">ACTUALIZAR</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal doble confirmaci√≥n eliminar (ESTILO B: ancho similar) -->
  <div id="deleteUserConfirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header delete-modal-header">
        <h2>ELIMINAR USUARIO</h2>
        <button class="close-btn" onclick="closeDeleteUserConfirmModal()">&times;</button>
      </div>
      <div class="warning-text" style="margin:8px 0 16px;">
        ‚ö†Ô∏è Esta acci√≥n es <strong>permanente</strong> y no se puede deshacer.
      </div>
      <div class="separator"></div>
      <div class="modal-buttons">
        <button type="button" class="btn-cancel" onclick="closeDeleteUserConfirmModal()">CANCELAR</button>
        <button type="button" class="btn-confirm-delete" id="deleteUserBtn">ELIMINAR DEFINITIVAMENTE</button>
      </div>
    </div>
  </div>

  <script>
    // ======================
    // Variables globales
    // ======================
    let currentEditingUser = null; // DOM element de la tarjeta clickeada
    const ADMIN_PASSWORD = "admin123";
    const API_URL = "http://localhost:3000/api/usuarios";

    // ======================
    // Helpers: Alertas internas
    // ======================
    function showSystemWarning(message) {
      const warning = document.createElement("div");
      warning.className = "system-warning";
      warning.textContent = message;
      document.body.appendChild(warning);
      setTimeout(() => warning.remove(), 4000);
    }

    // ======================
    // Funciones de modales
    // ======================
    function openAddUserModal() {
      document.getElementById("addUserModal").style.display = "flex";
      document.getElementById("addUserForm").reset();
    }
    function closeAddUserModal() {
      document.getElementById("addUserModal").style.display = "none";
    }
    function openPasswordConfirmModal() {
      document.getElementById("passwordConfirmModal").style.display = "flex";
      document.getElementById("passwordConfirmForm").reset();
      document.getElementById("passwordError").style.display = "none";
      document.getElementById("adminPassword").focus();
    }
    function closePasswordConfirmModal() {
      document.getElementById("passwordConfirmModal").style.display = "none";
    }

    function openEditUserModal(userElement) {
      if (!userElement) return;

      const userId = userElement.getAttribute("data-id");
      const userName = userElement.querySelector(".user-name").textContent;
      const userRole = userElement.querySelector(".user-role").textContent;
      const userEmail = userElement.getAttribute("data-email");

      document.getElementById("editUserId").value = userId;
      document.getElementById("editUserName").value = userName;
      document.getElementById("editUserRole").value = userRole;
      document.getElementById("editUserEmail").value = userEmail;
      document.getElementById("editUserPassword").value = "";

      document.getElementById("editUserModal").style.display = "flex";
      document.getElementById("editUserName").focus();
    }
    function closeEditUserModal() {
      document.getElementById("editUserModal").style.display = "none";
      currentEditingUser = null;
    }

    function openDeleteUserConfirmModal() {
      document.getElementById("deleteUserConfirmModal").style.display = "flex";
    }
    function closeDeleteUserConfirmModal() {
      document.getElementById("deleteUserConfirmModal").style.display = "none";
    }

    // ======================
    // Cargar usuarios desde BD
    // ======================
    async function cargarUsuarios() {
      try {
        const response = await fetch(API_URL);
        const usuarios = await response.json();

        const usersGrid = document.getElementById("usersGrid");
        usersGrid.innerHTML = "";

        usuarios.forEach((u) => {
          const userCard = document.createElement("div");
          userCard.className = "user-card";
          userCard.setAttribute("data-id", u.id_usuario);
          userCard.setAttribute("data-email", u.correo);
          userCard.innerHTML = `
            <div class="user-role">${u.rol}</div>
            <div class="user-name">${u.nombre_completo}</div>
          `;
          userCard.addEventListener("click", function () {
            currentEditingUser = this;
            openPasswordConfirmModal();
          });
          usersGrid.appendChild(userCard);
        });
      } catch (error) {
        console.error("Error al cargar usuarios:", error);
        showSystemWarning("‚ùå Error al cargar usuarios");
      }
    }

    // ======================
    // Agregar usuario
    // ======================
    document.getElementById("addUserForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const nombreCompleto = document.getElementById("userName").value.trim();
      const rol = document.getElementById("userRole").value;
      const correo = document.getElementById("userEmail").value.trim();
      const contrase√±a = document.getElementById("userPassword").value;

      const nuevoUsuario = {
        nombre_usuario: correo.split("@")[0],
        nombre_completo: nombreCompleto,
        correo,
        contrase√±a,
        rol,
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(nuevoUsuario),
        });

        if (!res.ok) throw new Error();

        showSystemWarning("‚úÖ Usuario agregado correctamente");
        closeAddUserModal();
        await cargarUsuarios();
      } catch {
        showSystemWarning("‚ùå Error al agregar usuario");
      }
    });

    // ======================
    // Confirmar contrase√±a admin
    // ======================
    document.getElementById("passwordConfirmForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const adminPassword = document.getElementById("adminPassword").value;
      const passwordError = document.getElementById("passwordError");

      if (adminPassword === ADMIN_PASSWORD) {
        passwordError.style.display = "none";
        closePasswordConfirmModal();
        setTimeout(() => {
          if (currentEditingUser) openEditUserModal(currentEditingUser);
        }, 200);
      } else {
        passwordError.style.display = "block";
        document.getElementById("adminPassword").value = "";
        document.getElementById("adminPassword").focus();
      }
    });

    // ======================
    // Editar usuario (actualizar BD)
    // ======================
    document.getElementById("editUserForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const id = document.getElementById("editUserId").value;
      const nombre_completo = document.getElementById("editUserName").value.trim();
      const correo = document.getElementById("editUserEmail").value.trim();
      const rol = document.getElementById("editUserRole").value;
      const nuevaPass = document.getElementById("editUserPassword").value;

      const usuarioActualizado = { nombre_completo, correo, rol };
      if (nuevaPass && nuevaPass.length > 0) {
        usuarioActualizado.contrase√±a = nuevaPass;
      }

      try {
        const res = await fetch(`${API_URL}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(usuarioActualizado),
        });

        if (!res.ok) throw new Error();

        showSystemWarning("‚úÖ Usuario actualizado correctamente");
        closeEditUserModal();
        await cargarUsuarios();
      } catch {
        showSystemWarning("‚ùå Error al actualizar usuario");
      }
    });

    // ======================
    // Abrir confirmaci√≥n de eliminar desde Edit
    // ======================
    document.getElementById("openDeleteUserConfirmBtn").addEventListener("click", function () {
      openDeleteUserConfirmModal();
    });

    // ======================
    // Eliminar usuario (doble confirmaci√≥n interna)
    // ======================
    document.getElementById("deleteUserBtn").addEventListener("click", async function () {
      const id = document.getElementById("editUserId").value;
      if (!id) return;

      try {
        const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
        if (!res.ok) throw new Error();

        showSystemWarning("üóëÔ∏è Usuario eliminado correctamente");
        closeDeleteUserConfirmModal();
        closeEditUserModal();
        await cargarUsuarios();
      } catch {
        showSystemWarning("‚ùå Error al eliminar usuario");
      }
    });

    // ======================
    // Cerrar modales al hacer clic fuera
    // ======================
    window.addEventListener("click", function (e) {
      ["addUserModal", "passwordConfirmModal", "editUserModal", "deleteUserConfirmModal"].forEach((id) => {
        const modal = document.getElementById(id);
        if (e.target === modal) modal.style.display = "none";
      });
    });

    // ======================
    // Cargar al iniciar
    // ======================
    document.addEventListener("DOMContentLoaded", cargarUsuarios);
  </script>

  <style>
    /* Toast interno de sistema (4s) */
    .system-warning {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #fff3cd;
      color: #856404;
      border: 2px solid #ffeeba;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.25);
      z-index: 9999;
      animation: fadeIn 0.25s ease;
      font-weight: bold;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Encabezado rojo para los modales de eliminaci√≥n (coincide con Interfaz.html) */
    .delete-modal-header {
      background: #ffeded;
      border-bottom: 1px solid #ffc8c8;
    }
    .delete-modal-header h2 {
      color: #b30000;
    }

    .warning-text {
      color: #8a6d3b;
      background: #fcf8e3;
      border: 1px solid #faebcc;
      padding: 10px 12px;
      border-radius: 6px;
    }

    .separator {
      height: 1px;
      background: #eee;
      margin: 10px 0 16px;
    }

    .btn-confirm-delete {
      background: #d9534f;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-confirm-delete:hover {
      filter: brightness(0.95);
    }
  </style>
</body>
</html>
