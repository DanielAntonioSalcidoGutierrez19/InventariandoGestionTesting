<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Ventas - Inventario</title>
  <link rel="stylesheet" href="./front/styles.css" />
  <style>
    /* ======= AJUSTES VISUALES ======= */

    .search-box {
      position: sticky;
      top: 0;
      background: #fff;
      padding: 10px 12px;
      z-index: 2;
      border-bottom: 1px solid #eef2f7;
    }
    #searchProducts {
      width: 100%;
      padding: 10px 14px 10px 38px;
      border: 1.5px solid #d1d5db;
      border-radius: 10px;
      outline: none;
      font-size: 14px;
      background: #ffffff;
      transition: border-color .15s ease, box-shadow .15s ease;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%2399a3ad" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85Zm-5.242.656a5 5 0 1 1 0-10a5 5 0 0 1 0 10Z"/></svg>');
      background-repeat: no-repeat;
      background-position: 12px center;
      background-size: 16px;
    }
    #searchProducts:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(96,165,250,.25);
    }

    /* Panel derecho */
    .cart-panel {
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .cart-title {
      padding: 12px 14px;
      border-bottom: 1px solid #eef2f7;
    }
    .cart-items {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 10px 12px 90px;
      box-sizing: border-box;
    }

    /* Barra total dentro del panel derecho */
    .checkout-bar {
      position: sticky;
      bottom: 0;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      padding: 12px;
      box-shadow: 0 -2px 12px rgba(0,0,0,.06);
      display: none;            /* visible solo cuando hay items */
      margin-top: 15px;
      z-index: 3;
    }
    .checkout-inner {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 12px;
      max-width: 90%;
      margin: 0 auto;
    }
    .total-strong {
      font-size: 15px;
      color: #111827;
      font-weight: 800;
    }
    .total-strong .label {
      font-weight: 700;
      color: #374151;
      margin-right: 6px;
    }

    /* Bot√≥n ticket */
    .btn-ticket-right {
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 700;
      background: #2196f3;
      color: #fff;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      transition: transform .06s ease, box-shadow .15s ease;
      box-shadow: 0 2px 8px rgba(33,150,243,.25);
    }
    .btn-ticket-right:hover { background:#1d86d9; }
    .btn-ticket-right:active { transform: scale(.98); }

    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
    }

    .payment-btn {
      background-color: #2196f3 !important;
      color: #fff !important;
      border: 2px solid #1976d2 !important;
    }
    .payment-btn.active-payment {
      background: #2ecc71 !important;
      border-color: #27ae60 !important;
      box-shadow: 0 0 15px rgba(46,204,113,.7);
    }

    .stock-warning {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #fff3cd;
      color: #856404;
      border: 2px solid #ffeeba;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,.3);
      z-index: 10000;
      font-weight: bold;
      animation: fadeIn .4s ease;
    }
    @keyframes fadeIn {
      from {opacity:0; transform:translateY(20px);}
      to {opacity:1; transform:translateY(0);}
    }

    /* üîπ reducir espacio blanco sobre los productos */
    .products-list {
  flex: 1;
  overflow-y: auto;
  padding-bottom: 40px;
  margin-top: 20px !important;   /* üîπ bajamos un poco los productos */
}

    body { overflow-x: hidden; }

    /* ‚úÖ AJUSTE: alinear alturas de panel izquierdo y ticket */
    .sales-container {
      display: flex;
      align-items: stretch;
    }
    .categories-panel {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 60px);  /* 60px aprox altura de la navbar */
      overflow: hidden;
    }
/* üîß Ajuste de altura para mostrar m√°s productos visibles */
.products-list {
  flex: 1;
  overflow-y: auto;
  padding-bottom: 40px;
  margin-top: 40px !important;
  height: calc(80vh - 350px) !important; /* üîπ aumenta el √°rea visible */
}


.categories-grid {
  margin-bottom: 20px !important; /* üîπ espacio extra entre categor√≠as y productos */
}

  </style>
</head>

<body>
  <!-- Barra superior -->
  <div class="navbar">
    <h1>SISTEMA DE VENTA</h1>
    <div class="menu">
      <a href="Interfazsupervisor.html">INVENTARIO</a>
      <a href="SistemaVentasSupervisor.html">VENTA</a>
      <a href="ReportesSupervisor.html">REPORTES</a>
      <a href="index.html">‚Æê SALIR</a>
    </div>
  </div>

  <!-- Contenedor principal -->
  <div class="sales-container">
    <!-- Panel izquierdo -->
    <div class="categories-panel" id="categoriesPanel">
      <div class="search-box">
        <input type="text" placeholder="üîç B√∫squeda de productos..." id="searchProducts" />
      </div>

      <div class="categories-title">CATEGOR√çAS</div>
      <div class="categories-grid">
        <button class="category-btn sabritas" onclick="filterByCategory('SABRITAS')"><span>SABRITAS</span></button>
        <button class="category-btn frutas" onclick="filterByCategory('FRUTAS Y VERDURAS')"><span>FRUTAS Y VERDURAS</span></button>
        <button class="category-btn limpieza" onclick="filterByCategory('LIMPIEZA')"><span>LIMPIEZA</span></button>
        <button class="category-btn bebidas" onclick="filterByCategory('BEBIDAS')"><span>BEBIDAS</span></button>
        <button class="category-btn farmacia" onclick="filterByCategory('FARMACIA')"><span>FARMACIA</span></button>
        <button class="category-btn abarrotes" onclick="filterByCategory('ABARROTES')"><span>ABARROTES</span></button>
      </div>

      <div class="products-list" id="productsList"></div>
    </div>

    <!-- Panel derecho -->
    <div class="cart-panel">
      <div class="cart-title">TICKET DE VENTA</div>
      <div class="cart-items" id="cartItems"></div>

      <!-- Barra total fija y bot√≥n ticket -->
      <div class="checkout-bar" id="checkoutBar">
        <div class="checkout-inner">
          <div class="total-strong">
            <span class="label">TOTAL A PAGAR:</span>
            <span id="totalAmount">$0.00</span>
          </div>
          <button class="btn-ticket-right" onclick="generateTicket()">TICKET</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal del ticket -->
  <div id="ticketModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>TICKET DE VENTA</h2>
        <button class="close-btn" onclick="closeTicketModal()">&times;</button>
      </div>

      <div class="ticket-content" id="ticketContent" style="text-align:center;">
        <!-- Logo arriba -->
        <img src="./front/img/inventariando.jpg" alt="inventariando" style="width:110px; margin-bottom:8px; opacity:0.85;">
      </div>

      <div class="payment-methods">
        <div class="payment-title">M√âTODO DE PAGO</div>
        <div class="payment-buttons">
          <button class="payment-btn btn-cash" onclick="selectPaymentMethod('efectivo')">EFECTIVO</button>
          <button class="payment-btn btn-transfer" onclick="selectPaymentMethod('transferencia')">TRANSFERENCIA</button>
        </div>

        <div class="cash-input-container" id="cashInputContainer" style="display:none;">
          <div class="cash-input-group">
            <label for="cashAmount">MONTO ENTREGADO:</label>
            <input type="number" id="cashAmount" placeholder="0.00" min="0" step="0.01" oninput="calculateChange()" />
          </div>
          <div class="change-display" id="changeDisplay" style="display:none;">
            CAMBIO: $<span id="changeAmount">0.00</span>
          </div>
        </div>
      </div>

      <!-- Botones centrados -->
      <div class="modal-buttons">
        <button class="modal-btn btn-cancel" onclick="closeTicketModal()">CERRAR</button>
        <button class="modal-btn btn-print" onclick="registerAndPrint()">IMPRIMIR</button>
      </div>
    </div>
  </div>

  <!-- ======= SCRIPT PRINCIPAL ======= -->
  <script>
    // === helpers de sesi√≥n (si los usas despu√©s puedes pegarlos aqu√≠) ===
    function getLoggedUserId() {
      const raw = localStorage.getItem("id_usuario");
      const n = raw !== null ? parseInt(raw, 10) : null;
      return Number.isNaN(n) ? null : n;
    }
    function ensureLoggedOrWarn() {
      const id = getLoggedUserId();
      if (id === null) {
        showSystemWarning("‚ö†Ô∏è No se detecta usuario en sesi√≥n. Inicia sesi√≥n de nuevo.");
      }
      return id;
    }

    const API_PRODUCTOS = "http://localhost:3000/api/productos";
    const API_VENTA = "http://localhost:3000/api/venta";

    let productos = [];
    let productsDB = {};
    let cart = [];
    let total = 0;
    let selectedPaymentMethod = "";
    let cashAmount = 0;
    let change = 0;

    // para doble clic de categor√≠a
    let currentCategory = "";

    document.addEventListener("DOMContentLoaded", async () => {
      ensureLoggedOrWarn();
      await loadProducts();
      hookSearch();
    });

    async function loadProducts() {
      try {
        const res = await fetch(API_PRODUCTOS);
        const data = await res.json();
        productos = Array.isArray(data) ? data : [];
        productsDB = {};
        productos.forEach((p) => {
          productsDB[String(p.id_producto)] = {
            name: p.nombre,
            price: Number(p.precio),
            stock: Number(p.stock),
            tipo: p.tipo || "",
            descripcion: p.descripcion || "",
            stock_minimo: Number(p.stock_minimo ?? 0),
          };
        });
        renderProducts(productos);
      } catch (err) {
        console.error(err);
        showSystemWarning("‚ùå Error al conectar con la base de datos");
      }
    }

    function renderProducts(list) {
      const container = document.getElementById("productsList");
      container.innerHTML = "";
      list.forEach((p) => {
        const div = document.createElement("div");
        div.className = "product-item";
        div.dataset.id = p.id_producto;
        div.dataset.price = p.precio;
        div.dataset.stock = p.stock;
        div.dataset.tipo = p.tipo || "";
        div.innerHTML = `
          <span class="product-name">${p.nombre}</span>
          <span class="product-price">$${Number(p.precio).toFixed(2)}</span>
          ${
            p.stock == 0
              ? '<div class="stock-low">‚ùå SIN STOCK</div>'
              : (p.stock <= p.stock_minimo
                  ? '<div class="stock-low">‚ö†Ô∏è POCO STOCK</div>'
                  : ''
                )
          }
        `;
        div.addEventListener("click", () => addToCartElement(div));
        container.appendChild(div);
      });
    }

    // FILTRAR POR CATEGORIA (con doble clic para limpiar)
    function filterByCategory(category) {
      if (currentCategory === category) {
        currentCategory = "";
        renderProducts(productos);
        return;
      }
      currentCategory = category;
      const filtered = productos.filter(p => p.tipo === category);
      renderProducts(filtered);
    }

    function hookSearch() {
      document.getElementById("searchProducts").addEventListener("input", (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = productos.filter(
          (p) =>
            p.nombre.toLowerCase().includes(searchTerm) ||
            (p.tipo || "").toLowerCase().includes(searchTerm) ||
            (p.descripcion || "").toLowerCase().includes(searchTerm)
        );
        renderProducts(filtered);
      });
    }

    // ‚ö†Ô∏è AVISO INTERNO (sin alert())
    function showSystemWarning(message) {
      const warning = document.createElement("div");
      warning.className = "stock-warning";
      warning.textContent = message;
      document.body.appendChild(warning);
      setTimeout(() => warning.remove(), 4000);
    }

    // üõí Agregar al carrito
    function addToCartElement(productElement) {
      const productId = productElement.dataset.id;
      const productName = productElement.querySelector(".product-name").textContent;
      const productPrice = parseFloat(productElement.dataset.price);
      const currentStock = Number(productsDB[productId]?.stock ?? 0);
      const stockMin = Number(productsDB[productId]?.stock_minimo ?? 0);

      if (currentStock <= 0) {
        showSystemWarning(`‚ùå Sin stock disponible de ${productName}`);
        return;
      }

      const existingItem = cart.find((item) => item.id === productId);
      let newQuantity = 1;

      if (existingItem) {
        if (existingItem.quantity + 1 > currentStock) {
          showSystemWarning(`‚ö†Ô∏è No hay suficiente stock de ${productName}`);
          return;
        }
        existingItem.quantity++;
        existingItem.subtotal = existingItem.quantity * existingItem.price;
        newQuantity = existingItem.quantity;
      } else {
        cart.push({
          id: productId,
          name: productName,
          price: productPrice,
          quantity: 1,
          subtotal: productPrice,
        });
      }

      const remaining = currentStock - newQuantity;
      if (remaining <= stockMin) showSystemWarning(`‚ö†Ô∏è ${productName} est√° llegando a su stock m√≠nimo (${remaining} uds).`);

      updateCartDisplay();
    }

    // üßÆ Actualizar carrito
    function updateCartDisplay() {
      const cartItemsContainer = document.getElementById("cartItems");
      const totalAmountElement = document.getElementById("totalAmount");
      const bar = document.getElementById("checkoutBar");
      cartItemsContainer.innerHTML = "";
      total = 0;
      cart.forEach((item) => {
        total += item.subtotal;
        const cartItemElement = document.createElement("div");
        cartItemElement.className = "cart-item";
        cartItemElement.innerHTML = `
          <div class="cart-item-info">
            <div class="cart-item-name">${item.name}</div>
            <div class="cart-item-price">$${item.price.toFixed(2)} c/u</div>
          </div>
          <div class="cart-item-quantity">
            <button class="quantity-btn" onclick="decreaseQuantity('${item.id}')">-</button>
            <span class="quantity">${item.quantity}</span>
            <button class="quantity-btn" onclick="increaseQuantity('${item.id}')">+</button>
          </div>
          <div class="cart-item-subtotal">$${item.subtotal.toFixed(2)}</div>
        `;
        cartItemsContainer.appendChild(cartItemElement);
      });
      totalAmountElement.textContent = `$${total.toFixed(2)}`;
      bar.style.display = cart.length > 0 ? "block" : "none";
    }

    // ‚ûï Aumentar cantidad
    function increaseQuantity(productId) {
      const item = cart.find((i) => i.id === productId);
      const stock = Number(productsDB[productId]?.stock ?? 0);
      const stockMin = Number(productsDB[productId]?.stock_minimo ?? 0);

      if (item.quantity + 1 > stock) {
        showSystemWarning(`‚ö†Ô∏è No hay suficiente stock de ${item.name}. Disponible: ${stock}`);
        return;
      }

      item.quantity++;
      item.subtotal = item.quantity * item.price;
      const remaining = stock - item.quantity;
      if (remaining <= stockMin) showSystemWarning(`‚ö†Ô∏è ${item.name} est√° en stock m√≠nimo (${remaining} uds).`);
      updateCartDisplay();
    }

    // ‚ûñ Disminuir cantidad
    function decreaseQuantity(productId) {
      const item = cart.find((i) => i.id === productId);
      if (!item) return;
      item.quantity--;
      if (item.quantity <= 0) cart = cart.filter((i) => i.id !== productId);
      else item.subtotal = item.quantity * item.price;
      updateCartDisplay();
    }

    // üí≥ M√©todos de pago (toggle / marca visual)
    function selectPaymentMethod(method) {
      selectedPaymentMethod = method;
      const cashContainer = document.getElementById("cashInputContainer");
      const changeDisplay = document.getElementById("changeDisplay");

      const btnCash = document.querySelector(".btn-cash");
      const btnTransfer = document.querySelector(".btn-transfer");

      // limpiar estado visual
      btnCash.classList.remove("active-payment");
      btnTransfer.classList.remove("active-payment");

      if (method === "efectivo") {
        btnCash.classList.add("active-payment");
        cashContainer.style.display = "block";
        changeDisplay.style.display = "none";
      } else if (method === "transferencia") {
        if (btnTransfer.classList.contains("active-payment")) {
          btnTransfer.classList.remove("active-payment");
          selectedPaymentMethod = "";
        } else {
          btnTransfer.classList.add("active-payment");
        }
        cashContainer.style.display = "none";
        changeDisplay.style.display = "none";
      }
    }

    // üíµ C√°lculo de cambio / faltante en efectivo (en vivo)
    function calculateChange() {
      const input = document.getElementById("cashAmount");
      const changeDisplay = document.getElementById("changeDisplay");

      cashAmount = parseFloat(input.value) || 0;

      if (total > 0 && cashAmount >= 0) {
        change = cashAmount - total;
        changeDisplay.style.display = "block";

        if (change < 0) {
          changeDisplay.innerHTML = `FALTAN: $<span id="changeAmount">${Math.abs(change).toFixed(2)}</span>`;
        } else {
          changeDisplay.innerHTML = `CAMBIO: $<span id="changeAmount">${change.toFixed(2)}</span>`;
        }
      } else {
        changeDisplay.style.display = "none";
      }
    }

    // üßæ Ticket (preview)
    function generateTicket() {
      if (cart.length === 0) return showSystemWarning("üõí No hay productos en el carrito");
      const ticket = document.getElementById("ticketContent");
      // reconstruimos contenido para evitar duplicados
      ticket.innerHTML = `<img src="./front/img/inventariando.jpg" alt="inventariando" style="width:110px; margin-bottom:8px; opacity:0.85;">`;
      let html = `<div style="text-align:center"><h3>TIENDA</h3><p>${new Date().toLocaleString()}</p></div>`;
      cart.forEach((i) => {
        html += `<div class="ticket-item"><span>${i.name} x${i.quantity}</span><span>$${i.subtotal.toFixed(2)}</span></div>`;
      });
      html += `<div class="ticket-total"><span>TOTAL:</span><span>$${total.toFixed(2)}</span></div>`;
      ticket.innerHTML += html;
      document.getElementById("ticketModal").style.display = "flex";
    }

    // üßæ Registrar venta
    async function registerAndPrint() {
      if (!selectedPaymentMethod) return showSystemWarning("Selecciona un m√©todo de pago");

      // Validar EFECTIVO antes
      if (selectedPaymentMethod === "efectivo") {
        const input = document.getElementById("cashAmount");
        cashAmount = parseFloat(input.value) || 0;
        if (cashAmount <= 0) return showSystemWarning("Ingresa el monto entregado en efectivo");
        if (cashAmount < total) return showSystemWarning(`Faltan $${(total - cashAmount).toFixed(2)} pesos.`);
      }

      try {
        const productosVenta = cart.map(i => ({
          id_producto: parseInt(i.id, 10),
          cantidad: i.quantity,
          precio_unitario: i.price
        }));

        const idUsuario = getLoggedUserId(); // si existe

        const response = await fetch(API_VENTA, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id_usuario: idUsuario ?? null,
            metodo_pago: selectedPaymentMethod,
            productos: productosVenta
          })
        });

        if (!response.ok) throw new Error("Error al registrar venta");

        showSystemWarning("‚úÖ Venta registrada correctamente");

        cart = [];
        updateCartDisplay();

        selectedPaymentMethod = "";
        document.querySelector(".btn-cash").classList.remove("active-payment");
        document.querySelector(".btn-transfer").classList.remove("active-payment");

        const input = document.getElementById("cashAmount");
        input.value = "";
        cashAmount = 0;
        change = 0;
        document.getElementById("changeDisplay").style.display = "none";
        document.getElementById("cashInputContainer").style.display = "none";

        closeTicketModal();
        await loadProducts();

      } catch (err) {
        console.error(err);
        showSystemWarning("‚ùå Error al registrar venta");
      }
    }

    function closeTicketModal() {
      document.getElementById("ticketModal").style.display = "none";
    }
  </script>
</body>
</html>
