<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administrador - Sistema de Inventario</title>
      <link rel="stylesheet" href="./front/styles.css">
</head>
<body>
  <!-- Barra superior -->
  <div class="navbar">
    <h1>SISTEMA DE INVENTARIO</h1>
    <div class="menu">
      <a href="Interfaz.html">INVENTARIO</a>
      <a href="SistemaVentasAdmin.html">VENTA</a>
      <a href="ReportesAdmin.html">REPORTES</a>
      <a href="Usuarios.html">USUARIOS</a>
      <a href="index.html">‚Æê SALIR</a>
    </div>
  </div>

  <!-- Botones principales -->
  <button class="boton" id="btn-reportes">REPORTES DIARIOS</button>
  <button class="boton" id="btn-ranking">RANKING DE ARTICULOS</button>

  <!-- Secci√≥n de Reportes Diarios -->
  <div class="seccion" id="seccion-reportes">
    <div class="fecha-seccion" id="fecha-reportes">--/--/----</div>
    <div class="titulo-seccion">Reportes Diario</div>
    
    <div class="datos-reporte">
      <div class="dato">
        <div class="dato-titulo">TICKETS</div>
        <div class="dato-valor">0 uds</div>
      </div>
      <div class="dato">
        <div class="dato-titulo">TOTAL</div>
        <div class="dato-valor">$0.00 mx</div>
      </div>
    </div>
    
    <!--div class="etiqueta-fecha">FECHA</div -->

    <!-- Tickets dia aparecer√°n aqui din√°micamente -->

    <!-- Botones de acci√≥n -->
    <div class="botones-accion">
      <button class="btn-accion btn-imprimir">
        üñ®Ô∏è IMPRIMIR REPORTE
      </button>
      <button class="btn-accion btn-fecha btn-fecha-reportes">
        üìÖ MODIFICAR FECHA
      </button>
    </div>
  </div>

  <!-- Secci√≥n de Ranking de Art√≠culos -->
  <div class="seccion" id="seccion-ranking">
    <div class="fecha-seccion" id="fecha-ranking">--/--/----</div>
    <div class="titulo-seccion">Ranking de art√≠culos</div>
    
    <div class="lista-articulos"></div>
    
    <div class="total-ranking">TOTAL: $0.00 mx</div>
    
    <!--div class="etiqueta-fecha">FECHA</div -->
    
    <!-- Tickets del d√≠a aparecer√°n aqu√≠ tambi√©n -->

    <!-- Botones de acci√≥n -->
    <div class="botones-accion">
      <button class="btn-accion btn-imprimir">
        üñ®Ô∏è IMPRIMIR RANKING
      </button>
      <button class="btn-accion btn-fecha btn-fecha-ranking">
        üìÖ MODIFICAR FECHA
      </button>
    </div>
  </div>

  <!-- Modal para modificar fecha -->
  <div class="modal" id="modal-fecha">
    <div class="modal-contenido">
      <div class="modal-titulo">Modificar Fecha</div>
      <input type="date" class="campo-fecha" id="nueva-fecha">
      <div class="botones-modal">
        <button class="btn-modal btn-cancelar" id="btn-cancelar">Cancelar</button>
        <button class="btn-modal btn-confirmar" id="btn-confirmar">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const btnReportes = document.getElementById('btn-reportes');
      const btnRanking = document.getElementById('btn-ranking');
      const seccionReportes = document.getElementById('seccion-reportes');
      const seccionRanking = document.getElementById('seccion-ranking');
      const btnImprimir = document.querySelectorAll('.btn-imprimir');
      const btnFechaReportes = document.querySelector('.btn-fecha-reportes');
      const btnFechaRanking = document.querySelector('.btn-fecha-ranking');
      const modalFecha = document.getElementById('modal-fecha');
      const btnCancelar = document.getElementById('btn-cancelar');
      const btnConfirmar = document.getElementById('btn-confirmar');
      const nuevaFecha = document.getElementById('nueva-fecha');
      const fechaReportes = document.getElementById('fecha-reportes');
      const fechaRanking = document.getElementById('fecha-ranking');
      
      let seccionActual = 'reportes'; // default

      // Mostrar secci√≥n de reportes
      btnReportes.addEventListener('click', function() {
        seccionReportes.classList.add('activa');
        seccionRanking.classList.remove('activa');
        seccionActual = 'reportes';
      });
      
      // Mostrar secci√≥n de ranking
      btnRanking.addEventListener('click', function() {
        seccionRanking.classList.add('activa');
        seccionReportes.classList.remove('activa');
        seccionActual = 'ranking';
      });

      btnImprimir.forEach(btn => {
        btn.addEventListener('click', function() {
          window.print();
        });
      });

      btnFechaReportes.addEventListener('click', function() {
        modalFecha.style.display = 'flex';
        seccionActual = 'reportes';
      });

      btnFechaRanking.addEventListener('click', function() {
        modalFecha.style.display = 'flex';
        seccionActual = 'ranking';
      });

      btnCancelar.addEventListener('click', function(){
        modalFecha.style.display = 'none';
      });

      btnConfirmar.addEventListener('click', async function(){
        const fechaISO = nuevaFecha.value;
        
        const fecha = new Date(fechaISO);
        const dia = String(fecha.getDate()).padStart(2,'0');
        const mes = String(fecha.getMonth()+1).padStart(2,'0');
        const a√±o = fecha.getFullYear();

        if(seccionActual === 'reportes'){
          fechaReportes.textContent = `${dia}/${mes}/${a√±o}`;
          await cargarReporteDiario(fechaISO);
        } else {
          fechaRanking.textContent = `${dia}/${mes}/${a√±o}`;
          await cargarRankingDia(fechaISO);
        }

        await cargarTicketsDia(fechaISO);

        modalFecha.style.display = 'none';
      });

      window.addEventListener('click',function(event){
        if(event.target === modalFecha){
          modalFecha.style.display = 'none';
        }
      });
    });
  </script>

  <!-- SEGUNDO SCRIPT REAL DATA -->
 <script>
  const API = "http://localhost:3000/api/venta";

  function ensureTicketContainer(seccionID){
    const seccion = document.getElementById(seccionID);

    if(seccionID !== "seccion-reportes") return null;

    if(!seccion.querySelector('.tickets-block')){
      const d = document.createElement("div");
      d.className="tickets-block";
      d.innerHTML = `
        <div class="titulo-seccion" style="margin-top:15px">Tickets del d√≠a</div>
        <div class="tickets-lista"></div>
      `;
      seccion.appendChild(d);
    }
    return seccion.querySelector('.tickets-lista');
  }

  async function cargarReporteDiario(fechaISO){
    const r = await fetch(API + "/reporte-dia/" + fechaISO);
    const data = await r.json();
    document.querySelector("#seccion-reportes .dato:nth-child(1) .dato-valor").textContent =
      (data.tickets||0)+" uds";
    document.querySelector("#seccion-reportes .dato:nth-child(2) .dato-valor").textContent =
      "$"+Number(data.total||0).toFixed(2)+"mx";
  }

  async function cargarRankingDia(fechaISO){
    const r = await fetch(API + "/ranking-dia/" + fechaISO);
    const data = await r.json();
    const lista = document.querySelector(".lista-articulos");
    lista.innerHTML="";
    let total=0;
    data.forEach(item=>{
      total+=Number(item.total_monto);
      const div=document.createElement("div");
      div.className="articulo";
      div.innerHTML=`
        <div class="nombre-articulo">${item.nombre}</div>
        <div class="cantidad-articulo">${item.total_vendido} uds</div>
        <div class="precio-articulo">$${Number(item.total_monto).toFixed(2)}mx</div>
      `;
      lista.appendChild(div);
    })
    document.querySelector(".total-ranking").textContent="TOTAL: $"+total.toFixed(2)+"mx";
  }

  async function cargarTicketsDia(fechaISO){
    const r = await fetch(API + "/tickets-dia/" + fechaISO);
    const data = await r.json();

    const listaRep = ensureTicketContainer("seccion-reportes");
    if(!listaRep) return;
    listaRep.innerHTML="";

    data.forEach(t=>{
      const f=new Date(t.fecha_venta);
      const hh=String(f.getHours()).padStart(2,'0');
      const mm=String(f.getMinutes()).padStart(2,'0');
      const ss=String(f.getSeconds()).padStart(2,'0');

     const row=document.createElement("div");
row.className="ticketrow";
row.style.display = "grid";
row.style.gridTemplateColumns = "200px 120px 120px";
row.style.columnGap = "15px";
row.style.alignItems = "center";
row.style.padding = "6px 0";
row.style.borderBottom = "1px solid #ddd";
row.innerHTML = `
  <div style="font-weight:bold">${t.folio}</div>
  <div style="text-align:center">${hh}:${mm}:${ss}</div>
  <div style="text-align:right">$${Number(t.total).toFixed(2)} mx</div>
`;
listaRep.appendChild(row);

    });
  }

  document.addEventListener("DOMContentLoaded",async()=>{
    const hoy=new Date();
    const y=hoy.getFullYear();
    const m=String(hoy.getMonth()+1).padStart(2,'0');
    const d=String(hoy.getDate()).padStart(2,'0');
    const fechaISO=`${y}-${m}-${d}`;

    document.getElementById("fecha-reportes").textContent=`${d}/${m}/${y}`;
    document.getElementById("fecha-ranking").textContent=`${d}/${m}/${y}`;

    await cargarReporteDiario(fechaISO);
    await cargarRankingDia(fechaISO);
    await cargarTicketsDia(fechaISO);
  })
</script>

</body>
</html>
