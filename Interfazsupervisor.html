<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Administrador - Sistema de Inventario</title>
  <link rel="stylesheet" href="./front/styles.css">
</head>
<body>
  <!-- Barra superior -->
  <div class="navbar">
    <h1>SISTEMA DE INVENTARIO</h1>
    <div class="menu">
      <a href="Interfazsupervisor.html">INVENTARIO</a>
      <a href="SistemaVentasSupervisor.html">VENTA</a>
      <a href="ReportesSupervisor.html">REPORTES</a>
      <a href="index.html">‚Æê SALIR</a>
    </div>
  </div>

  <!-- Contenedor -->
  <div class="container">
    <!-- Lista de productos -->
    <div class="inventory" id="inventoryList">
      <div class="search-box">
        <input type="text" placeholder="üîç B√∫squeda" id="searchInput">
      </div>
      <div id="dbItemsAnchor"></div>
    </div>

    <!-- Botones -->
    <div class="controls">
      <button class="btn btn-add" onclick="openAddModal()">AGREGAR</button>
      <button class="btn btn-delete" onclick="openDeleteModal()">ELIMINAR</button>
    </div>
  </div>

  <!-- Modal editar -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>EDITAR PRODUCTO</h2>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editForm" enctype="multipart/form-data">
        <div class="form-group"><label for="editName">NOMBRE</label><input type="text" id="editName" required></div>

        <div class="form-group">
          <label for="editTipo">TIPO</label>
          <select id="editTipo" required></select>
        </div>

        <div class="form-group"><label for="editDescripcion">DESCRIPCI√ìN</label><input type="text" id="editDescripcion" required></div>
        <div class="form-group"><label for="editQuantity">STOCK</label><input type="number" id="editQuantity" min="0" max="50" required></div>
        <!-- (Eliminado visual de STOCK M√çNIMO) -->
        <div class="form-group"><label for="editPrice">PRECIO</label><input type="number" id="editPrice" min="0" step="0.01" required></div>

        <!-- NUEVA IMAGEN OPCIONAL EN EDITAR -->
        <div class="form-group">
          <label for="editImage">NUEVA IMAGEN (opcional)</label>
          <input type="file" id="editImage" name="imagen" accept="image/*">
        </div>

        <!-- ALERTA DEL MODAL -->
        <div id="alertEdit" class="system-alert"></div>

        <div class="modal-buttons">
          <button type="button" class="btn btn-cancel" onclick="closeEditModal()">CANCELAR</button>
          <button type="submit" class="btn btn-save">GUARDAR</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal agregar -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>AGREGAR PRODUCTO</h2>
        <button class="close-btn" onclick="closeAddModal()">&times;</button>
      </div>
      <form id="addForm" enctype="multipart/form-data">
        <div class="form-group"><label for="addName">NOMBRE</label><input type="text" id="addName" required></div>

        <div class="form-group">
          <label for="addTipo">TIPO</label>
          <select id="addTipo" required></select>
        </div>

        <div class="form-group"><label for="addDescripcion">DESCRIPCI√ìN</label><input type="text" id="addDescripcion" required></div>
        <div class="form-group"><label for="addQuantity">STOCK</label><input type="number" id="addQuantity" min="0" max="50" required></div>
        <!-- (Eliminado visual de STOCK M√çNIMO en agregar) -->
        <div class="form-group"><label for="addPrice">PRECIO</label><input type="number" id="addPrice" min="0" step="0.01" required></div>

        <div class="form-group"><label for="addImage">IMAGEN</label><input type="file" id="addImage" name="imagen" accept="image/*" required></div>

        <!-- ALERTA DEL MODAL -->
        <div id="alertAdd" class="system-alert"></div>

        <div class="modal-buttons">
          <button type="button" class="btn btn-cancel" onclick="closeAddModal()">CANCELAR</button>
          <button type="submit" class="btn btn-confirm-add">AGREGAR</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal eliminar -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header delete-modal-header">
        <h2>ELIMINAR</h2>
        <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
      </div>
      <form id="deleteForm">
        <div class="warning-text">‚ö†Ô∏è Esta acci√≥n no se puede deshacer</div>
        <div class="form-group">
          <label for="deleteId">ID ART√çCULO</label>
          <input type="text" id="deleteId" required>
        </div>

        <!-- ALERTA DEL MODAL -->
        <div id="alertDelete" class="system-alert"></div>

        <div class="separator"></div>
        <div class="modal-buttons">
          <button type="button" class="btn btn-cancel" onclick="closeDeleteModal()">CANCELAR</button>
          <button type="submit" class="btn btn-confirm-delete">ELIMINAR</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Mini-modal overlay para doble confirmaci√≥n interna -->
  <div id="confirmDeleteOverlay" class="confirm-overlay">
    <div class="confirm-card">
      <h3 id="confirmTitle">Confirmar eliminaci√≥n</h3>
      <p id="confirmMessage">¬øEst√°s seguro que deseas eliminar este art√≠culo?</p>
      <div class="confirm-actions">
        <button id="confirmPrimary" class="btn btn-confirm-delete">S√≠, continuar</button>
        <button id="confirmSecondary" class="btn btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Estilos de alertas internas y overlay -->
  <style>
    /* Alertas internas en modales */
    .system-alert {
      width: 100%;
      text-align: center;
      padding: 10px;
      font-weight: bold;
      border-radius: 5px;
      margin-bottom: 12px;
      display: none;
    }
    .system-alert.error { background: #e74c3c; color: #ffffff; }
    .system-alert.success { background: #2ecc71; color: #ffffff; }

    /* Overlay doble confirmaci√≥n */
    .confirm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 16px;
    }
    .confirm-card {
      background: #e74c3c;
      color: #fff;
      max-width: 520px;
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      padding: 20px 22px;
      text-align: center;
    }
    .confirm-card h3 {
      margin: 0 0 8px 0;
      font-size: 1.25rem;
    }
    .confirm-card p {
      margin: 0 0 14px 0;
      line-height: 1.4;
    }
    .confirm-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .confirm-actions .btn {
      min-width: 160px;
    }
  </style>

  <script>
    const API_URL = "http://localhost:3000/api/productos";

    /* Helpers de alerta interna por modal */
    function showAlert(targetId, message, type = "error", autoHideMs = 3500) {
      const box = document.getElementById(targetId);
      if (!box) return;
      box.textContent = message;
      box.className = `system-alert ${type}`;
      box.style.display = "block";
      if (autoHideMs) setTimeout(() => { box.style.display = "none"; }, autoHideMs);
    }

    /* Referencias inputs */
    const addName = document.getElementById('addName');
    const addTipo = document.getElementById('addTipo');
    const addDescripcion = document.getElementById('addDescripcion');
    const addQuantity = document.getElementById('addQuantity');
    const addPrice = document.getElementById('addPrice');

    const editName = document.getElementById('editName');
    const editTipo = document.getElementById('editTipo');
    const editDescripcion = document.getElementById('editDescripcion');
    const editQuantity = document.getElementById('editQuantity');
    const editPrice = document.getElementById('editPrice');

    const deleteId = document.getElementById('deleteId');

    /* Overlay confirm delete */
    const overlay = document.getElementById('confirmDeleteOverlay');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmPrimary = document.getElementById('confirmPrimary');
    const confirmSecondary = document.getElementById('confirmSecondary');

    function openOverlay() { overlay.style.display = 'flex'; }
    function closeOverlay() { overlay.style.display = 'none'; }

    function setConfirmStep(step, proceed) {
      if (step === 1) {
        confirmTitle.textContent = 'Confirmar eliminaci√≥n';
        confirmMessage.textContent = '¬øEst√°s seguro que deseas eliminar este art√≠culo?';
        confirmPrimary.textContent = 'S√≠, continuar';
        confirmSecondary.textContent = 'Cancelar';
        confirmPrimary.onclick = () => setConfirmStep(2, proceed);
        confirmSecondary.onclick = () => closeOverlay();
      } else {
        confirmTitle.textContent = 'Confirmaci√≥n final';
        confirmMessage.textContent = 'ESTA ACCI√ìN ES PERMANENTE y NO se podr√° deshacer. ¬øRealmente deseas eliminarlo?';
        confirmPrimary.textContent = 'S√≠, eliminar definitivamente';
        confirmSecondary.textContent = 'Atr√°s';
        confirmPrimary.onclick = async () => { closeOverlay(); await proceed(); };
        confirmSecondary.onclick = () => setConfirmStep(1, proceed);
      }
    }
    function doubleConfirmDelete(proceed) { setConfirmStep(1, proceed); openOverlay(); }

    /* Render de items (sin mostrar STOCK M√çNIMO) */
    function createItemElement(p) {
      const div = document.createElement("div");
      div.className = "item";
      div.dataset.id = p.id_producto;
      div.dataset.tipo = p.tipo ?? "";
      div.dataset.descripcion = p.descripcion ?? "";

      const info = document.createElement("div");
      info.className = "item-info";
      const precioTxt = Number(p.precio ?? 0).toFixed(2);
      info.innerHTML = `<strong>${p.nombre}</strong> ‚Äî ID: ${p.id_producto} ‚Äî CANTIDAD: ${p.stock} ‚Äî PRECIO: $${precioTxt}`;

      const img = document.createElement("img");
      img.src = p.imagen ? ("http://localhost:3000" + p.imagen) : "";
      img.alt = p.nombre || "producto";
      img.style.width = "50px";
      img.style.height = "50px";
      img.style.objectFit = "contain";
      img.style.marginLeft = "15px";

      const btn = document.createElement("button");
      btn.className = "btn btn-edit";
      btn.textContent = "EDITAR";
      btn.onclick = () => openEditModal(btn);

      div.appendChild(info);
      if (p.imagen) div.appendChild(img);
      div.appendChild(btn);

      return div;
    }

    async function loadProductos() {
      try {
        const res = await fetch(API_URL);
        const productos = await res.json();

        const anchor = document.getElementById("dbItemsAnchor");
        anchor.innerHTML = "";

        if (!Array.isArray(productos) || !productos.length) {
          anchor.innerHTML = `<p style="text-align:center; padding:1rem;">No hay productos registrados.</p>`;
          return;
        }

        productos.forEach(p => anchor.appendChild(createItemElement(p)));
      } catch (err) {
        console.error("Error al cargar productos:", err);
      }
    }

    document.getElementById("searchInput").addEventListener("input", async (e) => {
      const term = e.target.value.trim();
      try {
        const url = term ? `${API_URL}?search=${encodeURIComponent(term)}` : API_URL;
        const res = await fetch(url);
        const productos = await res.json();

        const anchor = document.getElementById("dbItemsAnchor");
        anchor.innerHTML = "";

        if (!Array.isArray(productos) || !productos.length) {
          anchor.innerHTML = `<p style="padding:1rem; text-align:center;">No se encontraron productos.</p>`;
          return;
        }

        productos.forEach((p) => anchor.appendChild(createItemElement(p)));
      } catch (error) {
        console.error("Error al buscar productos:", error);
      }
    });

    async function openAddModal(){
      await loadTiposEnum();
      document.getElementById('alertAdd').style.display = 'none';
      document.getElementById('addModal').style.display='flex';
    }
    function closeAddModal(){ document.getElementById('addModal').style.display='none'; }

    async function openEditModal(btn){
      const item = btn.closest('.item');
      const infoText = item.querySelector('.item-info').textContent;
      const nombreMatch = infoText.match(/^\s*(.*?)\s*‚Äî/);
      const cantidadMatch = infoText.match(/CANTIDAD:\s*(\d+)/);
      const precioMatch = infoText.match(/PRECIO:\s*\$(\d+(?:\.\d+)?)/);

      editName.value = (nombreMatch ? nombreMatch[1] : "").trim();
      editQuantity.value = cantidadMatch ? cantidadMatch[1] : 0;
      editPrice.value = precioMatch ? precioMatch[1] : 0;

      await loadTiposEnumEdit(item.dataset.tipo || "");
      editDescripcion.value = item.dataset.descripcion || "";
      document.getElementById('editForm').dataset.id = item.dataset.id;
      document.getElementById('editImage').value = ""; // limpia selecci√≥n previa

      document.getElementById('alertEdit').style.display = 'none';
      document.getElementById('editModal').style.display='flex';
    }

    function closeEditModal(){ document.getElementById('editModal').style.display='none'; }
    function openDeleteModal(){
      document.getElementById('alertDelete').style.display = 'none';
      document.getElementById('deleteModal').style.display='flex';
    }
    function closeDeleteModal(){ document.getElementById('deleteModal').style.display='none'; }

    /* ADD: FormData con imagen obligatoria y stock_minimo=5 autom√°tico */
    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const stockVal = Number(addQuantity.value || 0);
      if (stockVal > 50) {
        showAlert('alertAdd', 'El STOCK m√°ximo permitido es 50. Se ajust√≥ a 50.', 'error');
        addQuantity.value = 50;
        return;
      }

      try {
        const formData = new FormData();
        formData.append("nombre", addName.value);
        formData.append("tipo", addTipo.value);
        formData.append("descripcion", addDescripcion.value);
        formData.append("stock", addQuantity.value);
        formData.append("stock_minimo", 5);               // ‚Üê SIEMPRE 5 (oculto)
        formData.append("precio", addPrice.value);
        formData.append("imagen", document.getElementById("addImage").files[0]);

        const res = await fetch(API_URL, { method: 'POST', body: formData });
        const j = await res.json().catch(()=>({}));
        if (!res.ok || j.success === false) throw new Error(j.message || 'No se pudo agregar el producto');

        showAlert('alertAdd', '‚úÖ Producto agregado correctamente', 'success');
        await loadProductos();
        e.target.reset();

        setTimeout(() => { closeAddModal(); }, 1000);
      } catch (err) {
        console.error('addForm:', err);
        showAlert('alertAdd', err.message || 'No se pudo agregar el producto', 'error');
      }
    });

    /* EDIT: FormData con imagen OPCIONAL y stock_minimo=5 autom√°tico */
    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = e.target.dataset.id;

      const stockVal = Number(editQuantity.value || 0);
      if (stockVal > 50) {
        showAlert('alertEdit', 'El STOCK m√°ximo permitido es 50. Se ajust√≥ a 50.', 'error');
        editQuantity.value = 50;
        return;
      }

      try {
        const formData = new FormData();
        formData.append("nombre", editName.value);
        formData.append("tipo", editTipo.value);
        formData.append("descripcion", editDescripcion.value);
        formData.append("stock", editQuantity.value);
        formData.append("stock_minimo", 5);               // ‚Üê SIEMPRE 5 (oculto)
        formData.append("precio", editPrice.value);
        const newImg = document.getElementById("editImage").files[0];
        if (newImg) formData.append("imagen", newImg);

        const res = await fetch(`${API_URL}/${id}`, { method: 'PUT', body: formData });
        const j = await res.json().catch(()=>({}));
        if (!res.ok || j.success === false) throw new Error(j.message || 'No se pudo actualizar el producto');

        showAlert('alertEdit', '‚úÖ Producto actualizado correctamente', 'success');
        await loadProductos();

        setTimeout(() => { closeEditModal(); }, 1000);
      } catch (err) {
        console.error('editForm:', err);
        showAlert('alertEdit', err.message || 'No se pudo actualizar el producto', 'error');
      }
    });

    /* DELETE con doble confirmaci√≥n interna */
    document.getElementById('deleteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = deleteId.value.trim();
      if (!id) { showAlert('alertDelete', 'Ingresa un ID v√°lido', 'error'); return; }

      doubleConfirmDelete(async () => {
        try {
          const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
          const j = await res.json().catch(()=>({}));
          if (!res.ok || j.success === false) throw new Error(j.message || 'No se pudo eliminar el producto');

          showAlert('alertDelete', 'üóëÔ∏è Producto eliminado correctamente', 'success');
          const card = document.querySelector(`.item[data-id='${id}']`);
          if (card) card.remove();
          deleteId.value = '';

          setTimeout(() => { closeDeleteModal(); }, 1000);
        } catch (err) {
          console.error('deleteForm:', err);
          showAlert('alertDelete', err.message || 'No se pudo eliminar el producto', 'error');
        }
      });
    });

    async function loadTiposEnum(){
      try{
        const res = await fetch("http://localhost:3000/api/productos/tipos");
        const tipos = await res.json();
        const sel = document.getElementById("addTipo");
        sel.innerHTML = "";
        tipos.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          sel.appendChild(opt);
        });
      }catch(err){
        console.error('loadTiposEnum:', err);
      }
    }

    async function loadTiposEnumEdit(selectedTipo){
      try{
        const res = await fetch("http://localhost:3000/api/productos/tipos");
        const tipos = await res.json();
        const sel = document.getElementById("editTipo");
        sel.innerHTML = "";
        tipos.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          if(selectedTipo === t) opt.selected = true;
          sel.appendChild(opt);
        });
      }catch(err){
        console.error('loadTiposEnumEdit:', err);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await loadProductos();
      await loadTiposEnum();
    });
  </script>
</body>
</html>
